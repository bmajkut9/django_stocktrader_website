{% extends "base.html" %} {% block title %} Home {% endblock %}
{% block content %}

<script>
    function showData(type, text) {
        document.getElementById('gainers').style.display = 'none';
        document.getElementById('losers').style.display = 'none';
        document.getElementById('mostActive').style.display = 'none';

        document.getElementById(type).style.display = '';
        document.getElementById('dropdownMenuButton').textContent = text;
    }
</script>

<style>
    .triangle-up {
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-bottom: 20px solid green;
        margin-left: auto;
        margin-right: auto;
    }

    .triangle-down {
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-top: 20px solid red;
        margin-left: auto;
        margin-right: auto;
    }
</style>

<div class="container">
    <div class="row">
        <div class="col mr-auto" style="margin-top: 10px;">
            <div class="row">
                <h4>Your investments</h4>
            </div>
            <div class="row">
                <h1>${{investment_assets}}</h1>
                <h3 style="margin-left: 10px">2.61%</h3>
                <div class="triangle-up" style="margin-left: 5px; margin-bottom: auto;"></div>
            </div>
            <div>
                <canvas style="width: 100%" id="myChart"></canvas>
            </div>
            <div style="height: 20px;"></div>
            <h4>News and Sentiments</h4>
            <div class="row">
                {% for article in articles %}
                <a href="{{article.link}}">
                    <div class="container border"
                        style="width: 200px; margin-left: 20px; margin-right: 20px; justify-content: center;">
                        <div class="col" style="justify-content: center;">
                            <div class="container border" style="width: 100%; height: 100px; border-radius: 10px;">
                                <img src="{{article.image}}"
                                    style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px;">
                            </div>
                            <p class="title-text border">{{article.title}}</p>
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        <div style="width: 60px;"></div>
        <div class="ml-auto">
            <button class="btn btn-success w-100 border" style="margin-top: 30px; margin-bottom: 20px; border-width: 3px !important; 
                border-color: lightgreen !important; height: 70px; border-radius: 16px;">INVEST</button>
            <div class="container border" style="border-width: 3px !important; border-radius: 20px;">
                <div class="dropdown"
                    style="display: flex; justify-content: center; width: 100%; margin-top: 15px; margin-bottom: 15px;">
                    <button class="btn dropdown-toggle" style="background-color: #dee2e6;" type="button"
                        id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Most Active
                    </button>
                    <div class="dropdown-menu" style="margin-left: auto; margin-right: auto;"
                        aria-labelledby="dropdownMenuButton">
                        <a class="dropdown-item" onclick="showData('gainers', 'Biggest Gainers')">Biggest
                            Gainers</a>
                        <a class="dropdown-item" onclick="showData('losers', 'Biggest Losers')">Biggest Losers</a>
                        <a class="dropdown-item" onclick="showData('mostActive', 'Most Active')">Most Active</a>
                    </div>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th scope="col">Ticker</th>
                            <th scope="col">% Change</th>
                            <th scope="col">Trend</th>
                        </tr>
                    </thead>
                    <tbody id="gainers" style="display: none;">
                        {% for gainer in gainers %}
                        <tr>
                            <th scope="row">{{gainer.symbol}}</th>
                            <td>{{gainer.change_percentage}}</td>
                            <td>
                                <div class="triangle-up"></div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tbody id="losers" style="display: none;">
                        {% for loser in losers %}
                        <tr>
                            <th scope="row">{{loser.symbol}}</th>
                            <td>{{loser.change_percentage}}</td>
                            <td>
                                <div class="triangle-down"></div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tbody id="mostActive">
                        {% for active in mostActive %}
                        <tr>
                            <th scope="row">{{active.symbol}}</th>
                            <td>{{active.change_percentage}}</td>
                            <td>{% if active.change_percentage >= 0 %}
                                <div class="triangle-up"></div>
                                {% else %}
                                <div class="triangle-down"></div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<script>

    const roundedBackgroundPlugin = {
        id: 'roundedBackground',
        beforeDraw: (chart) => {
            const ctx = chart.ctx;
            const chartArea = chart.chartArea;
            const radius = 20; // Adjust the radius for the desired roundness

            ctx.save();
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)'; // Background color
            ctx.strokeStyle = 'rgba(0, 0, 0, 0.1)'; // Border color
            ctx.lineWidth = 2; // Border width

            // Draw rounded rectangle
            ctx.beginPath();
            ctx.moveTo(chartArea.left + radius, chartArea.top);
            ctx.lineTo(chartArea.right - radius, chartArea.top);
            ctx.quadraticCurveTo(chartArea.right, chartArea.top, chartArea.right, chartArea.top + radius);
            ctx.lineTo(chartArea.right, chartArea.bottom - radius);
            ctx.quadraticCurveTo(chartArea.right, chartArea.bottom, chartArea.right - radius, chartArea.bottom);
            ctx.lineTo(chartArea.left + radius, chartArea.bottom);
            ctx.quadraticCurveTo(chartArea.left, chartArea.bottom, chartArea.left, chartArea.bottom - radius);
            ctx.lineTo(chartArea.left, chartArea.top + radius);
            ctx.quadraticCurveTo(chartArea.left, chartArea.top, chartArea.left + radius, chartArea.top);
            ctx.closePath();

            ctx.fill();
            ctx.stroke();
            ctx.restore();

            ctx.save();
            ctx.strokeStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.lineWidth = 1;

            const xGridLineCount = chart.scales.x.ticks.length;
            for (let i = 1; i < xGridLineCount - 1; i++) {
                const x = chart.scales.x.getPixelForTick(i);
                ctx.beginPath();
                ctx.moveTo(x, chartArea.top);
                ctx.lineTo(x, chartArea.bottom);
                ctx.stroke();
            }

            // Draw y-axis grid lines
            const yGridLineCount = chart.scales.y.ticks.length;
            for (let i = 1; i < yGridLineCount - 1; i++) {
                const y = chart.scales.y.getPixelForTick(i);
                ctx.beginPath();
                ctx.moveTo(chartArea.left, y);
                ctx.lineTo(chartArea.right, y);
                ctx.stroke();
            }

            ctx.restore();
        }
    };

    // Register the plugin
    Chart.register(roundedBackgroundPlugin);

    const ctx = document.getElementById('myChart');
    /*console.log("{{ chart_data.dates }}");
    console.log("{{chart_data}}");
    const dates = JSON.parse("{{ chart_data.dates|safe }}");
    console.log("dates are");
    console.log(dates);*/
    //const cumulativeValues = JSON.parse('{{ chart_data.cumulative_values|escapejs }}');
    //console.log("values are")
    //console.log(cumulativeValues)
    const chartData = JSON.parse('{{ chart_data|safe }}');
    console.log(chartData);

    const dates = chartData.dates;
    const cumulativeValues = chartData.cumulative_values;

    console.log(dates);
    console.log(cumulativeValues);

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Investments in USD',
                data: cumulativeValues,
                fill: false,
                borderColor: 'rgba(75, 192, 192, 1)',
                tension: 0.4,
                pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                pointBorderColor: 'rgba(75, 192, 192, 1)',
                pointBorderWidth: 1,
                pointRadius: 5,
                pointHoverRadius: 5,
                pointHoverBackgroundColor: 'rgba(75, 192, 192, 1)',
                pointHoverBorderColor: 'rgba(75, 192, 192, 1)',
                pointHoverBorderWidth: 2,
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false,
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Date'
                    },
                    grid: {
                        display: false,
                    },
                    border: {
                        display: false,
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Value $USD',
                    },
                    grid: {
                        display: false,
                    },
                    border: {
                        display: false,
                    }
                }
            }
        }
    });


</script>

{% endblock %}